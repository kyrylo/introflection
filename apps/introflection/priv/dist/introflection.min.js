/*! introflection 09-03-2015 */
"use strict";THREE.OrbitControls=function(a,b){function c(){return 2*Math.PI/60/60*o.autoRotateSpeed}function d(){return Math.pow(.95,o.zoomSpeed)}function e(a){if(o.enabled!==!1){if(a.preventDefault(),a.button===o.mouseButtons.ORBIT){if(o.noRotate===!0)return;I=H.ROTATE,q.set(a.clientX,a.clientY)}else if(a.button===o.mouseButtons.ZOOM){if(o.noZoom===!0)return;I=H.DOLLY,y.set(a.clientX,a.clientY)}else if(a.button===o.mouseButtons.PAN){if(o.noPan===!0)return;I=H.PAN,t.set(a.clientX,a.clientY)}I!==H.NONE&&(document.addEventListener("mousemove",f,!1),document.addEventListener("mouseup",g,!1),o.dispatchEvent(M))}}function f(a){if(o.enabled!==!1){a.preventDefault();var b=o.domElement===document?o.domElement.body:o.domElement;if(I===H.ROTATE){if(o.noRotate===!0)return;r.set(a.clientX,a.clientY),s.subVectors(r,q),o.rotateLeft(2*Math.PI*s.x/b.clientWidth*o.rotateSpeed),o.rotateUp(2*Math.PI*s.y/b.clientHeight*o.rotateSpeed),q.copy(r)}else if(I===H.DOLLY){if(o.noZoom===!0)return;z.set(a.clientX,a.clientY),A.subVectors(z,y),A.y>0?o.dollyIn():o.dollyOut(),y.copy(z)}else if(I===H.PAN){if(o.noPan===!0)return;u.set(a.clientX,a.clientY),v.subVectors(u,t),o.pan(v.x,v.y),t.copy(u)}I!==H.NONE&&o.update()}}function g(){o.enabled!==!1&&(document.removeEventListener("mousemove",f,!1),document.removeEventListener("mouseup",g,!1),o.dispatchEvent(N),I=H.NONE)}function h(a){if(o.enabled!==!1&&o.noZoom!==!0&&I===H.NONE){a.preventDefault(),a.stopPropagation();var b=0;void 0!==a.wheelDelta?b=a.wheelDelta:void 0!==a.detail&&(b=-a.detail),b>0?o.dollyOut():o.dollyIn(),o.update(),o.dispatchEvent(M),o.dispatchEvent(N)}}function i(a){if(o.enabled!==!1&&o.noKeys!==!0&&o.noPan!==!0)switch(a.keyCode){case o.keys.UP:o.pan(0,o.keyPanSpeed),o.update();break;case o.keys.BOTTOM:o.pan(0,-o.keyPanSpeed),o.update();break;case o.keys.LEFT:o.pan(o.keyPanSpeed,0),o.update();break;case o.keys.RIGHT:o.pan(-o.keyPanSpeed,0),o.update()}}function j(a){if(o.enabled!==!1){switch(a.touches.length){case 1:if(o.noRotate===!0)return;I=H.TOUCH_ROTATE,q.set(a.touches[0].pageX,a.touches[0].pageY);break;case 2:if(o.noZoom===!0)return;I=H.TOUCH_DOLLY;var b=a.touches[0].pageX-a.touches[1].pageX,c=a.touches[0].pageY-a.touches[1].pageY,d=Math.sqrt(b*b+c*c);y.set(0,d);break;case 3:if(o.noPan===!0)return;I=H.TOUCH_PAN,t.set(a.touches[0].pageX,a.touches[0].pageY);break;default:I=H.NONE}I!==H.NONE&&o.dispatchEvent(M)}}function k(a){if(o.enabled!==!1){a.preventDefault(),a.stopPropagation();var b=o.domElement===document?o.domElement.body:o.domElement;switch(a.touches.length){case 1:if(o.noRotate===!0)return;if(I!==H.TOUCH_ROTATE)return;r.set(a.touches[0].pageX,a.touches[0].pageY),s.subVectors(r,q),o.rotateLeft(2*Math.PI*s.x/b.clientWidth*o.rotateSpeed),o.rotateUp(2*Math.PI*s.y/b.clientHeight*o.rotateSpeed),q.copy(r),o.update();break;case 2:if(o.noZoom===!0)return;if(I!==H.TOUCH_DOLLY)return;var c=a.touches[0].pageX-a.touches[1].pageX,d=a.touches[0].pageY-a.touches[1].pageY,e=Math.sqrt(c*c+d*d);z.set(0,e),A.subVectors(z,y),A.y>0?o.dollyOut():o.dollyIn(),y.copy(z),o.update();break;case 3:if(o.noPan===!0)return;if(I!==H.TOUCH_PAN)return;u.set(a.touches[0].pageX,a.touches[0].pageY),v.subVectors(u,t),o.pan(v.x,v.y),t.copy(u),o.update();break;default:I=H.NONE}}}function l(){o.enabled!==!1&&(o.dispatchEvent(N),I=H.NONE)}this.object=a,this.domElement=void 0!==b?b:document,this.enabled=!0,this.target=new THREE.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.minDistance=0,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};var m,n,o=this,p=1e-6,q=new THREE.Vector2,r=new THREE.Vector2,s=new THREE.Vector2,t=new THREE.Vector2,u=new THREE.Vector2,v=new THREE.Vector2,w=new THREE.Vector3,x=new THREE.Vector3,y=new THREE.Vector2,z=new THREE.Vector2,A=new THREE.Vector2,B=0,C=0,D=1,E=new THREE.Vector3,F=new THREE.Vector3,G=new THREE.Quaternion,H={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},I=H.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone();var J=(new THREE.Quaternion).setFromUnitVectors(a.up,new THREE.Vector3(0,1,0)),K=J.clone().inverse(),L={type:"change"},M={type:"start"},N={type:"end"};this.rotateLeft=function(a){void 0===a&&(a=c()),C-=a},this.rotateUp=function(a){void 0===a&&(a=c()),B-=a},this.panLeft=function(a){var b=this.object.matrix.elements;w.set(b[0],b[1],b[2]),w.multiplyScalar(-a),E.add(w)},this.panUp=function(a){var b=this.object.matrix.elements;w.set(b[4],b[5],b[6]),w.multiplyScalar(a),E.add(w)},this.pan=function(a,b){var c=o.domElement===document?o.domElement.body:o.domElement;if(void 0!==o.object.fov){var d=o.object.position,e=d.clone().sub(o.target),f=e.length();f*=Math.tan(o.object.fov/2*Math.PI/180),o.panLeft(2*a*f/c.clientHeight),o.panUp(2*b*f/c.clientHeight)}else void 0!==o.object.top?(o.panLeft(a*(o.object.right-o.object.left)/c.clientWidth),o.panUp(b*(o.object.top-o.object.bottom)/c.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.dollyIn=function(a){void 0===a&&(a=d()),D/=a},this.dollyOut=function(a){void 0===a&&(a=d()),D*=a},this.update=function(){var a=this.object.position;x.copy(a).sub(this.target),x.applyQuaternion(J),m=Math.atan2(x.x,x.z),n=Math.atan2(Math.sqrt(x.x*x.x+x.z*x.z),x.y),this.autoRotate&&I===H.NONE&&this.rotateLeft(c()),m+=C,n+=B,m=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,m)),n=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,n)),n=Math.max(p,Math.min(Math.PI-p,n));var b=x.length()*D;b=Math.max(this.minDistance,Math.min(this.maxDistance,b)),this.target.add(E),x.x=b*Math.sin(n)*Math.sin(m),x.y=b*Math.cos(n),x.z=b*Math.sin(n)*Math.cos(m),x.applyQuaternion(K),a.copy(this.target).add(x),this.object.lookAt(this.target),C=0,B=0,D=1,E.set(0,0,0),(F.distanceToSquared(this.object.position)>p||8*(1-G.dot(this.object.quaternion))>p)&&(this.dispatchEvent(L),F.copy(this.object.position),G.copy(this.object.quaternion))},this.reset=function(){I=H.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.update()},this.getPolarAngle=function(){return n},this.getAzimuthalAngle=function(){return m},this.domElement.addEventListener("contextmenu",function(a){a.preventDefault()},!1),this.domElement.addEventListener("mousedown",e,!1),this.domElement.addEventListener("mousewheel",h,!1),this.domElement.addEventListener("DOMMouseScroll",h,!1),this.domElement.addEventListener("touchstart",j,!1),this.domElement.addEventListener("touchend",l,!1),this.domElement.addEventListener("touchmove",k,!1),window.addEventListener("keydown",i,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls;var Introflection={REVISION:"1"};Introflection.start=function(){var a,b;log.enableAll(),a=new Introflection.WebSocketConnection("ws://localhost:8080/ws"),a.start(),b=new Introflection.Scene(a),b.init()},Introflection.Grid=function(a){"undefined"!=typeof a&&(this.size=void 0!==a.size?a.size:100,this.step=void 0!==a.step?a.step:2,this.axisSize=void 0!==a.axisSize?a.axisSize:20,this.enabled=void 0!==a.enabled?a.enabled:[]),this.scene=a.scene,this.isVisible=a.visible,this.gridXZ=null,this.gridYZ=null,this.gridXY=null,this.axes=null,this.applyDefaults()},Introflection.Grid.prototype={constructor:Introflection.Grid,applyDefaults:function(){0!==this.enabled.length&&this.enabled.forEach(function(a){this.toggle(a)},this)},toggle:function(a){"axes"===a?this.toggleAxes():this.toggleGrid(a)},toggleGrid:function(a){var b="grid"+a;null!==this[b]&&this[b].visible?this.hideGrid(b):this.showGrid(b)},showGrid:function(a){if(null!==this[a])this[a].visible=!0;else{switch(this[a]=new THREE.GridHelper(this.size,this.step),this.visible||this.hideGrid(a),a){case"gridYZ":this[a].rotation.z=Math.PI/2;break;case"gridXY":this[a].rotation.x=Math.PI/2}this.scene.add(this[a])}},hideGrid:function(a){null!==this[a]&&(this[a].visible=!1)},toggleAxes:function(){null!==this.axes&&this.axes.visible?this.axes.visible=!1:null!==this.axes?this.axes.visible=!0:(this.axes=new THREE.AxisHelper(this.axisSize),this.visible||(this.axes.visible=!1),this.scene.add(this.axes))}},Introflection.ModuleAddedEvent=function(){this.includes=[],this.inherits_from=[],this.name="",this.nested_under=[],this.nesting_level=-1,this.origin="",this.type=""},Introflection.ModuleAddedEvent.prototype={constructor:Introflection.ModuleAddedEvent,handle:function(a){this.type=a.type,this.origin=a.origin,this.nesting_level=a.nesting_level,a.nested_under.forEach(function(a){this.nested_under.push(String.fromCharCode.apply(this,a))},this),this.name=String.fromCharCode.apply(this,a.name),a.includes.forEach(function(a){this.includes.push(String.fromCharCode.apply(this,a))},this)}},Introflection.Module=function(a){this.moduleAddedEvent=new Introflection.ModuleAddedEvent,this.moduleAddedEvent.handle(a.data)},Introflection.Module.prototype={constructor:Introflection.Module,display:function(a,b){var c=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshLambertMaterial({color:"blue"}));c.position.x=5*b+5,a.add(c)}},Introflection.EventDispatcher=function(){this.scene=null,this.count=0},Introflection.EventDispatcher.prototype={constructor:Introflection.EventDispatcher,dispatch:function(a){var b,c;switch(b=JSON.parse(a.data),b.event){case"module_added":c=new Introflection.Module(b),c.display(this.scene,this.count),this.count++}}},Introflection.WebSocketConnection=function(a){this.socket=null,this.scene=null,this.url=a,this.subprotocol="ifproto",this.dispatcher=new Introflection.EventDispatcher},Introflection.WebSocketConnection.prototype={constructor:Introflection.WebSocketConnection,start:function(a){this.dispatcher.scene=a;var b=new WebSocket(this.url,this.subprotocol);this.setHandlers(b)},setHandlers:function(a){this.setOnopen(a),this.setOnclose(a),this.setOnerror(a),this.setOnmessage(a)},setOnopen:function(a){a.onopen=function(){log.info("Established a new websocket connection on "+this.url)}},setOnclose:function(a){a.onclose=function(a){var b="Closed the websocket connection on "+this.url+" ";if(a.wasClean)log.info(b+"without errors");else{var c=b+"with errors. Error ("+a.code+"): "+a.reason;log.info(c)}}},setOnerror:function(a){a.onerror=function(a){log.warn("An error occurred: "+a.message)}},setOnmessage:function(a){var b=this;a.onmessage=function(a){b.dispatcher.dispatch(a)}}},Introflection.Stats=function(){this.stats=new Stats,this.modes={fps:0,ms:1}},Introflection.Stats.prototype={constructor:Introflection.Stats,start:function(){this.stats.setMode(this.modes.ms),this.stats.domElement.style.position="absolute",this.stats.domElement.style.left="0px",this.stats.domElement.style.top="0px",document.body.appendChild(this.stats.domElement)},update:function(){this.stats.update()}},Introflection.GUI=function(){this.gui=new dat.GUI,this.options={},this.optionsController={gridX:!0,gridY:!1,gridZ:!1,axes:!0}},Introflection.GUI.prototype={constructor:Introflection.GUI,start:function(){var a=[["gridX","Show XZ grid"],["gridY","Show YZ grid"],["gridZ","Show XY grid"],["axes","Show axes"]];a.forEach(function(a){this.addMenuItem(a[0],a[1])},this)},addMenuItem:function(a,b){this.gui.add(this.optionsController,a).name(b)},changedItems:function(){var a,b,c,d,e;return b=this.optionsController.gridX!==this.options.gridX,c=this.optionsController.gridY!==this.options.gridY,d=this.optionsController.gridZ!==this.options.gridZ,e=this.optionsController.axes!==this.options.axes,a={x:b,y:c,z:d,a:e,empty:!0},(b||c||d||e)&&(a.empty=!1),a},updateOptions:function(){this.options.gridX=this.optionsController.gridX,this.options.gridY=this.optionsController.gridY,this.options.gridZ=this.optionsController.gridZ,this.options.axes=this.optionsController.axes}},Introflection.Scene=function(a){var b=window.innerWidth/window.innerHeight;this.ws=a,this.scene=new THREE.Scene,this.container=document.getElementById("container"),this.camera=new THREE.PerspectiveCamera(75,b,1,1e3),this.renderer=new THREE.WebGLRenderer,this.cameraControls=new THREE.OrbitControls(this.camera),this.ambientLight=new THREE.AmbientLight(68),this.directionalLight=new THREE.DirectionalLight(16777215),this.stats=new Introflection.Stats,this.gui=new Introflection.GUI,this.grid=new Introflection.Grid({scene:this.scene,visible:!1,enabled:["XZ","axes"]})},Introflection.Scene.prototype={constructor:Introflection.Scene,init:function(){this.ws.start(this.scene),this.setOnResize(),this.setRendererSize(),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setClearColor(11184810,1),this.container.appendChild(this.renderer.domElement),this.scene.add(this.ambientLight),this.directionalLight.position.set(1,1,1).normalize(),this.scene.add(this.directionalLight),this.camera.position.z=10,this.camera.position.y=10,this.cameraControls.damping=.2,this.cameraControls.addEventListener("change",this.render.bind(this)),this.stats.start(),this.gui.start(),this.animate.apply(this)},setRendererSize:function(){this.renderer.setSize(window.innerWidth,window.innerHeight)},setOnResize:function(){window.addEventListener("resize",this.resizeFunc.bind(this),!1)},resizeFunc:function(){var a,b;a=window.innerWidth/2,b=window.innerHeight/2,this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.setRendererSize()},animate:function(){window.requestAnimationFrame(Introflection.Scene.prototype.animate.bind(this)),this.render(),this.cameraControls.update(),this.stats.update()},render:function(){var a;a=this.gui.changedItems(),a.empty||(this.gui.updateOptions(),this.drawHelpers(a)),this.renderer.render(this.scene,this.camera)},drawHelpers:function(a){a.x&&this.grid.toggle("XZ"),a.y&&this.grid.toggle("YZ"),a.z&&this.grid.toggle("XY"),a.a&&this.grid.toggle("axes")}},document.addEventListener("DOMContentLoaded",function(){Introflection.start()});